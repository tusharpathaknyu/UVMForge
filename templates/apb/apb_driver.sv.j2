//------------------------------------------------------------------------------
// APB Driver - Generated by VerifAI
//------------------------------------------------------------------------------

class {{ prefix }}_driver extends uvm_driver #({{ prefix }}_seq_item);
    
    `uvm_component_utils({{ prefix }}_driver)
    
    // Virtual interface
    virtual {{ prefix }}_if.master vif;
    
    // Constructor
    function new(string name = "{{ prefix }}_driver", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    // Build phase
    virtual function void build_phase(uvm_phase phase);
        super.build_phase(phase);
        if (!uvm_config_db#(virtual {{ prefix }}_if.master)::get(this, "", "vif", vif))
            `uvm_fatal(get_type_name(), "Virtual interface not found")
    endfunction
    
    // Run phase
    virtual task run_phase(uvm_phase phase);
        {{ prefix }}_seq_item req;
        
        // Initialize signals
        reset_signals();
        
        // Wait for reset
        @(posedge vif.{{ clock }});
        wait({% if reset_active_low %}vif.{{ reset }}{% else %}!vif.{{ reset }}{% endif %});
        
        forever begin
            seq_item_port.get_next_item(req);
            drive_transfer(req);
            seq_item_port.item_done();
        end
    endtask
    
    // Reset signals to idle state
    virtual task reset_signals();
        vif.master_cb.psel    <= 1'b0;
        vif.master_cb.penable <= 1'b0;
        vif.master_cb.pwrite  <= 1'b0;
        vif.master_cb.paddr   <= '0;
        vif.master_cb.pwdata  <= '0;
{% if apb_version >= 4 %}
        vif.master_cb.pstrb   <= '0;
{% endif %}
    endtask
    
    // Drive a single APB transfer
    virtual task drive_transfer({{ prefix }}_seq_item req);
        // Setup phase
        @(vif.master_cb);
        vif.master_cb.psel    <= 1'b1;
        vif.master_cb.penable <= 1'b0;
        vif.master_cb.pwrite  <= (req.trans_type == APB_WRITE);
        vif.master_cb.paddr   <= req.addr;
        vif.master_cb.pwdata  <= req.data;
{% if apb_version >= 4 %}
        vif.master_cb.pstrb   <= req.strb;
{% endif %}
        
        // Access phase
        @(vif.master_cb);
        vif.master_cb.penable <= 1'b1;
        
        // Wait for ready
        do @(vif.master_cb);
        while (!vif.master_cb.pready);
        
        // Capture response
        req.rdata = vif.master_cb.prdata;
        req.resp  = apb_resp_type_e'(vif.master_cb.pslverr);
        
        // Return to idle
        vif.master_cb.psel    <= 1'b0;
        vif.master_cb.penable <= 1'b0;
        
        `uvm_info(get_type_name(), $sformatf("Drove: %s", req.convert2string()), UVM_HIGH)
    endtask
    
endclass : {{ prefix }}_driver
