//------------------------------------------------------------------------------
// APB Monitor - Generated by VerifAI
//------------------------------------------------------------------------------

class {{ prefix }}_monitor extends uvm_monitor;
    
    `uvm_component_utils({{ prefix }}_monitor)
    
    // Virtual interface
    virtual {{ prefix }}_if.monitor vif;
    
    // Analysis port
    uvm_analysis_port #({{ prefix }}_seq_item) ap;
    
    // Constructor
    function new(string name = "{{ prefix }}_monitor", uvm_component parent = null);
        super.new(name, parent);
        ap = new("ap", this);
    endfunction
    
    // Build phase
    virtual function void build_phase(uvm_phase phase);
        super.build_phase(phase);
        if (!uvm_config_db#(virtual {{ prefix }}_if.monitor)::get(this, "", "vif", vif))
            `uvm_fatal(get_type_name(), "Virtual interface not found")
    endfunction
    
    // Run phase
    virtual task run_phase(uvm_phase phase);
        {{ prefix }}_seq_item txn;
        
        // Wait for reset
        @(posedge vif.{{ clock }});
        wait({% if reset_active_low %}vif.{{ reset }}{% else %}!vif.{{ reset }}{% endif %});
        
        forever begin
            @(vif.monitor_cb);
            
            // Detect setup phase (PSEL=1, PENABLE=0)
            if (vif.monitor_cb.psel && !vif.monitor_cb.penable) begin
                txn = {{ prefix }}_seq_item::type_id::create("txn");
                txn.addr = vif.monitor_cb.paddr;
                txn.trans_type = apb_trans_type_e'(vif.monitor_cb.pwrite);
                txn.data = vif.monitor_cb.pwdata;
{% if apb_version >= 4 %}
                txn.strb = vif.monitor_cb.pstrb;
{% endif %}
                
                // Wait for access phase completion
                do @(vif.monitor_cb);
                while (!vif.monitor_cb.pready || !vif.monitor_cb.penable);
                
                // Capture response
                txn.rdata = vif.monitor_cb.prdata;
                txn.resp = apb_resp_type_e'(vif.monitor_cb.pslverr);
                
                // Send to analysis port
                ap.write(txn);
                
                `uvm_info(get_type_name(), $sformatf("Observed: %s", txn.convert2string()), UVM_HIGH)
            end
        end
    endtask
    
endclass : {{ prefix }}_monitor
